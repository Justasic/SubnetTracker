{# Extend the basic HTML template. #}
{% extends 'base.html' %}
{% load staticfiles %}

{# Set window title #}
{% block title %}Subnets{% endblock %}

{# Include any CSS or JS assets into the page. #}
{% block head %}
    <script src="{% static 'js/jquery-1.10.2.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'css/front.css' %}">
{% endblock %}

{# Define the page content. #}
{% block body %}
    <h1 class="title">Current CIDR subnets</h1>
    <div class="table">
    <table class="subnet_table">
        <thead>
            <tr>
                <th>Name</th>
                <th>CIDR</th>
            </tr>
        </thead>

        {% for c in cidrs %}
            <tr id="cidr_{{ c.id }}">
                <td>{{ c.name }}</td>
                <td>{{ c.cidr }}</td>
                <td id="x_button"><a href="javascript:deleteRow({{ c.id }})">Remove '{{ c.name }}'</a></td>
            </tr>
        {% endfor %}
    </table>
    </div>

    <br />
    <div class="form">
        <p>Add a CIDR address: <div class="error"></div></p>
        <form action="/cidradd/" method="POST" id="form">{% csrf_token %}
            Name: {{ cidr_form.name }}
            CIDR: {{ cidr_form.cidr }}
            <input type="submit" value="Submit" />
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
    /* Handle the AJAX call to add a CIDR mask */
    var frm = $('#form');
    frm.submit(function () {
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            dataType: 'json',
            success: function (res) {
                if(res.error){
                    var e = $(".error");
                    if(res.id){
                        e.text("CIDR address already allocated as '" + res.name + "'");
                    }else{
                        e.text(res.error);
                    }
                    e.show();
                }else{
                    $(".error").hide();
                    var name = $('#id_name');
                    var cidr = $('#id_cidr');
                    addRow(res.success, name.val(), cidr.val());
                    handleUpdate(true);
                    name.val('');
                    cidr.val('');
                }
            },
            error: function(data) {
                var e = $(".error");
                e.text("A server error occured.");
                e.show();
            }
        });
        return false;
    });

    /* Handle the deletion of an item */
    function deleteRow(row_id){
        $.get("/cidrremove/"+row_id+"/").done(function(){
            removeRow(row_id);
        }).fail(function(){
            alert("Server error occured.");
        });}

    /* These are helper functions for handleUpdate to make the code cleaner */
    function removeRow(row_id){
        $('#cidr_'+row_id).remove();
    }

    function addRow(row_id, name, cidr){
        $(".subnet_table tr:last").after('<tr id="cidr_'+row_id+'"><td>'+name+'</td><td>'+cidr+
            '</td><td><a href="javascript:deleteRow('+row_id+')">Remove \''+name+'\'</a></td></tr>');
    }

    function inArray(item, array){
        for(var i = 0; i < array.length; i++)
        {
            if(item.name === array[i].name)
                return true;
        }
        return false;
    }

    /* Handle live updating of the table */
    var tableData;
    function handleUpdate(forceUpdate){
        $.ajax({
           url: '/cidrlist/',
           dataType: 'json',
           success: function(_data){
               var data = [];
               $.each(_data, function(i, item){data[i] = item;});
               /* force an update and disregard array comparisons. */
               if(forceUpdate){ tableData = data; }
               else{
                   /* Compare the existing array to check if an item was removed server-side */
                   for(var i = 0; i < tableData.length; i++){
                       if(!inArray(tableData[i], data)){removeRow(tableData[i].id);}}

                   /* Compare the existing array to check if an item was added server-side */
                   for(var i = 0; i < data.length; i++){
                       if (!inArray(data[i], tableData)){addRow(data[i].id, data[i].name, data[i].mask);}}

                   tableData = data;
               }
           }
        });
    }
    /* Check for updates every 2 seconds - I hate timers but I can't find a more efficient way */
    $(document).ready(function(){ handleUpdate(true); setInterval(function(){handleUpdate(false)}, 2000); });
    </script>
{% endblock %}